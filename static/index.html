<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontu√°rio Eletr√¥nico Hands-Free</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #2c3e50;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.5rem 1rem 1rem;
        }
        
        .controls-compact {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex-wrap: wrap;
        }
        
        .encounter-input {
            flex: 1;
            min-width: 200px;
        }
        
        .encounter-input input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .encounter-input input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            margin-left: auto;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .status.disconnected {
            background: #fed7d7;
            color: #c53030;
        }
        
        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status.recording {
            background: #fef5e7;
            color: #c05621;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .panels-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 1rem;
            border-left: 4px solid;
        }
        
        .panel-sindromico {
            border-left-color: #3498db;
        }
        
        .panel-hipoteses {
            border-left-color: #e74c3c;
        }
        
        .panel-perguntas {
            border-left-color: #f39c12;
        }
        
        .panel-condutas {
            border-left-color: #27ae60;
        }
        
        .panel h3 {
            font-size: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-content {
            line-height: 1.6;
        }
        
        .panel-content.empty {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 2rem 0;
        }
        
        .hipoteses-list {
            list-style: none;
        }
        
        .hipotese-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #e74c3c;
        }
        
        .hipotese-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .hipotese-nome {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .confidence {
            background: #e74c3c;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .hipotese-razoes {
            font-size: 0.9rem;
            color: #5a6c7d;
        }
        
        .perguntas-list, .condutas-list {
            list-style: none;
        }
        
        .perguntas-list li, .condutas-list li {
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .perguntas-list li:before {
            content: "‚ùì";
            margin-right: 0.5rem;
        }
        
        .condutas-list li:before {
            content: "üí°";
            margin-right: 0.5rem;
        }
        
        .condutas-list li:first-child:before {
            content: "üö®";
        }
        
        .transcript-column {
            display: flex;
            flex-direction: column;
        }
        
        .panel-transcript {
            border-left-color: #9b59b6;
            max-width: 100%;
            height: 100%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .transcript-status {
            font-size: 0.8rem;
            font-weight: normal;
            color: #7f8c8d;
            margin-left: 0.5rem;
        }
        
        .transcript-status.recording {
            color: #e74c3c;
            animation: pulse 2s infinite;
        }
        
        .transcript-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .transcript-placeholder {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 2rem 0;
        }
        
        .transcript-text {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .transcript-new {
            background: linear-gradient(90deg, #e8f5e8 0%, transparent 100%);
            animation: fadeIn 0.5s ease-in;
            padding: 0.2rem;
            border-radius: 4px;
            margin: 0.2rem 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; background: #c8e6c9; }
            to { opacity: 1; background: transparent; }
        }
        
        .update-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid #e1e8ed;
        }
        
        .last-update {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .recording-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            z-index: 1000;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .controls-compact {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .controls-compact .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="recording-indicator" id="recordingIndicator">
        üé§
    </div>


    <div class="container">
        <div class="main-layout">
            <!-- Coluna da Transcri√ß√£o (Esquerda) -->
            <div class="transcript-column">
                <div class="controls-compact">
                    <button class="btn btn-primary" id="startBtn">
                        üé§ Iniciar Consulta
                    </button>
                    <button class="btn btn-danger" id="stopBtn" disabled>
                        ‚èπÔ∏è Finalizar Consulta
                    </button>
                    <div class="status disconnected" id="statusIndicator">
                        Desconectado
                    </div>
                </div>
                
                <div class="panel panel-transcript">
                    <h3>
                        üé§ Transcri√ß√£o da Consulta
                        <span class="transcript-status" id="transcriptStatus">Aguardando...</span>
                    </h3>
                    <div class="transcript-content" id="transcript-content">
                        <div class="transcript-placeholder">
                            Inicie a consulta para ver a transcri√ß√£o em tempo real...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coluna dos Pain√©is Cl√≠nicos (Direita) -->
            <div class="panels-grid">
                <!-- Painel Sindr√¥mico -->
                <div class="panel panel-sindromico">
                    <h3>
                        üîç Diagn√≥stico Sindr√¥mico
                    </h3>
                    <div class="panel-content empty" id="sindromico-content">
                        Aguardando dados da consulta...
                    </div>
                </div>

                <!-- Painel Hip√≥teses -->
                <div class="panel panel-hipoteses">
                    <h3>
                        üéØ Hip√≥teses Diagn√≥sticas
                    </h3>
                    <div class="panel-content empty" id="hipoteses-content">
                        Aguardando dados da consulta...
                    </div>
                </div>

                <!-- Painel Perguntas -->
                <div class="panel panel-perguntas">
                    <h3>
                        ‚ùì Perguntas a Fazer
                    </h3>
                    <div class="panel-content empty" id="perguntas-content">
                        Aguardando dados da consulta...
                    </div>
                </div>

                <!-- Painel Condutas -->
                <div class="panel panel-condutas">
                    <h3>
                        üíä Condutas Sugeridas
                    </h3>
                    <div class="panel-content empty" id="condutas-content">
                        Aguardando dados da consulta...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MedicalRecordApp {
            constructor() {
                this.audioWs = null;
                this.panelsWs = null;
                this.mediaRecorder = null;
                this.audioStream = null;
                this.isRecording = false;
                this.currentEncounter = null;
                
                this.initializeElements();
                this.initializeEventListeners();
                this.generateDefaultEncounterId();
            }
            
            initializeElements() {
                // this.encounterInput = document.getElementById('encounterId'); // Removed
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.statusIndicator = document.getElementById('statusIndicator');
                // this.lastUpdate = document.getElementById('lastUpdate'); // Removed element
                this.recordingIndicator = document.getElementById('recordingIndicator');
                
                // Panel content elements
                this.sindromicContent = document.getElementById('sindromico-content');
                this.hipotesesContent = document.getElementById('hipoteses-content');
                this.perguntasContent = document.getElementById('perguntas-content');
                this.condutasContent = document.getElementById('condutas-content');
                
                // Transcript elements
                this.transcriptContent = document.getElementById('transcript-content');
                this.transcriptStatus = document.getElementById('transcriptStatus');
                this.lastTranscriptLength = 0;
            }
            
            initializeEventListeners() {
                this.startBtn.addEventListener('click', () => this.startConsultation());
                this.stopBtn.addEventListener('click', () => this.stopConsultation());
            }
            
            generateDefaultEncounterId() {
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/[-:T]/g, '');
                return `ATD-${timestamp}`;
            }
            
            async startConsultation() {
                try {
                    const encounterId = this.generateDefaultEncounterId();
                    
                    this.currentEncounter = encounterId;
                    
                    // Request microphone permission
                    this.audioStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        } 
                    });
                    
                    // Setup WebSocket connections
                    await this.setupWebSockets(encounterId);
                    
                    // Setup audio recording
                    this.setupAudioRecording();
                    
                    // Update UI
                    this.updateUIState('recording');
                    
                } catch (error) {
                    console.error('Erro ao iniciar consulta:', error);
                    alert('Erro ao acessar microfone. Verifique as permiss√µes.');
                }
            }
            
            async setupWebSockets(encounterId) {
                return new Promise((resolve, reject) => {
                    let connectionsReady = 0;
                    
                    // Audio WebSocket
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsHost = window.location.host;
                    
                    this.audioWs = new WebSocket(`${protocol}//${wsHost}/ws/audio/${encounterId}`);
                    
                    this.audioWs.onopen = () => {
                        console.log('Conex√£o de √°udio estabelecida');
                        connectionsReady++;
                        if (connectionsReady === 2) resolve();
                    };
                    
                    this.audioWs.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.type === 'final_report') {
                            this.handleFinalReport(data.data);
                        }
                    };
                    
                    this.audioWs.onerror = (error) => {
                        console.error('Erro no WebSocket de √°udio:', error);
                        reject(error);
                    };
                    
                    // Panels WebSocket
                    this.panelsWs = new WebSocket(`${protocol}//${wsHost}/ws/panels/${encounterId}`);
                    
                    this.panelsWs.onopen = () => {
                        console.log('Conex√£o de pain√©is estabelecida');
                        connectionsReady++;
                        if (connectionsReady === 2) resolve();
                    };
                    
                    this.panelsWs.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'transcript_update') {
                            // Atualiza√ß√£o imediata da transcri√ß√£o
                            this.updateTranscript(data.transcript || '');
                        } else {
                            // Atualiza√ß√£o completa dos pain√©is
                            this.updatePanels(data);
                        }
                    };
                    
                    this.panelsWs.onerror = (error) => {
                        console.error('Erro no WebSocket de pain√©is:', error);
                        reject(error);
                    };
                });
            }
            
            setupAudioRecording() {
                // Implementar solu√ß√£o de cycleRecorder para arquivos WebM v√°lidos
                this.chunkSeq = 0;
                this.INTERVAL_MS = 6000; // 6 segundos por ciclo
                
                // Verificar formato suportado
                const MIME = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(MIME)) {
                    console.warn('WebM Opus n√£o suportado, usando fallback');
                    this.mimeType = 'audio/webm';
                } else {
                    this.mimeType = MIME;
                }
                
                console.log('Using audio format:', this.mimeType);
                
                // Iniciar primeiro ciclo de grava√ß√£o
                this.cycleRecorder();
                this.isRecording = true;
            }
            
            cycleRecorder() {
                if (!this.isRecording) return;
                
                // Fechar recorder anterior (se existir)
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop(); // disparar√° ondataavailable com WebM completo
                }
                
                // Criar novo recorder com o MESMO stream (n√£o parar o stream!)
                this.mediaRecorder = new MediaRecorder(this.audioStream, { 
                    mimeType: this.mimeType, 
                    audioBitsPerSecond: 128000 
                });
                
                this.mediaRecorder.ondataavailable = async (event) => {
                    if (!event.data || event.data.size === 0) return;
                    
                    const blob = event.data; // WebM completo (com headers)
                    console.log(`Arquivo WebM completo gerado: ${blob.size} bytes, tipo: ${blob.type}`);
                    
                    // Enviar via WebSocket bin√°rio
                    if (this.audioWs?.readyState === WebSocket.OPEN) {
                        this.audioWs.send(blob);
                        this.chunkSeq++;
                        console.log(`Enviado chunk #${this.chunkSeq}: ${blob.size} bytes`);
                    }
                };
                
                this.mediaRecorder.onerror = (error) => {
                    console.error('Erro no MediaRecorder:', error);
                };
                
                // Iniciar grava√ß√£o sem timeslice - controlamos o ciclo manualmente
                this.mediaRecorder.start();
                console.log(`Iniciando novo ciclo MediaRecorder #${this.chunkSeq + 1}`);
                
                // Agendar pr√≥ximo ciclo em 6s, garantindo arquivo completo por segmento
                this.recordingTimeout = setTimeout(() => {
                    this.cycleRecorder();
                }, this.INTERVAL_MS);
            }
            
            async stopConsultation() {
                try {
                    // Parar flag de grava√ß√£o primeiro para cancelar ciclos
                    this.isRecording = false;
                    
                    // Cancelar timeout do pr√≥ximo ciclo de grava√ß√£o
                    if (this.recordingTimeout) {
                        clearTimeout(this.recordingTimeout);
                        this.recordingTimeout = null;
                        console.log('Timeout do ciclo de grava√ß√£o cancelado');
                    }
                    
                    // Send finalization signal
                    if (this.audioWs?.readyState === WebSocket.OPEN) {
                        this.audioWs.send('__finalize__');
                    }
                    
                    // Stop recording if active
                    if (this.mediaRecorder?.state === 'recording') {
                        this.mediaRecorder.stop();
                    }
                    
                    // Stop audio stream
                    if (this.audioStream) {
                        this.audioStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Close WebSockets after a delay to allow final processing
                    setTimeout(() => {
                        this.audioWs?.close();
                        this.panelsWs?.close();
                    }, 2000);
                    
                    // Update UI
                    this.updateUIState('stopped');
                    console.log('Consulta finalizada');
                    
                } catch (error) {
                    console.error('Erro ao finalizar consulta:', error);
                }
            }
            
            updateUIState(state) {
                switch (state) {
                    case 'recording':
                        this.startBtn.disabled = true;
                        this.stopBtn.disabled = false;
                        // this.encounterInput.disabled = true; // Removed field
                        this.statusIndicator.className = 'status recording';
                        this.statusIndicator.textContent = 'Gravando...';
                        this.recordingIndicator.style.display = 'block';
                        this.transcriptStatus.textContent = 'Gravando...';
                        this.transcriptStatus.className = 'transcript-status recording';
                        break;
                        
                    case 'stopped':
                        this.startBtn.disabled = false;
                        this.stopBtn.disabled = true;
                        // this.encounterInput.disabled = false; // Removed field
                        this.statusIndicator.className = 'status disconnected';
                        this.statusIndicator.textContent = 'Desconectado';
                        this.recordingIndicator.style.display = 'none';
                        this.transcriptStatus.textContent = 'Aguardando...';
                        this.transcriptStatus.className = 'transcript-status';
                        this.resetTranscript();
                        // this.generateDefaultEncounterId(); // No longer needed in stopped state
                        break;
                }
            }
            
            updatePanels(data) {
                const updateTime = new Date(data.updated_at * 1000);
                // this.lastUpdate.textContent = `√öltima atualiza√ß√£o: ${updateTime.toLocaleString('pt-BR')}`; // Element removed
                
                // Update syndromic panel
                this.sindromicContent.className = 'panel-content';
                this.sindromicContent.textContent = data.sindromico || 'Sem dados suficientes...';
                
                // Update hypotheses panel
                if (data.hipoteses && data.hipoteses.length > 0) {
                    this.hipotesesContent.className = 'panel-content';
                    this.hipotesesContent.innerHTML = this.renderHypotheses(data.hipoteses);
                } else {
                    this.hipotesesContent.className = 'panel-content empty';
                    this.hipotesesContent.textContent = 'Aguardando dados para gerar hip√≥teses...';
                }
                
                // Update questions panel
                if (data.perguntas && data.perguntas.length > 0) {
                    this.perguntasContent.className = 'panel-content';
                    this.perguntasContent.innerHTML = this.renderList(data.perguntas, 'perguntas-list');
                } else {
                    this.perguntasContent.className = 'panel-content empty';
                    this.perguntasContent.textContent = 'Nenhuma pergunta espec√≠fica no momento...';
                }
                
                // Update management panel
                if (data.condutas && data.condutas.length > 0) {
                    this.condutasContent.className = 'panel-content';
                    this.condutasContent.innerHTML = this.renderList(data.condutas, 'condutas-list');
                } else {
                    this.condutasContent.className = 'panel-content empty';
                    this.condutasContent.textContent = 'Aguardando dados para sugerir condutas...';
                }
                
                // Update transcript
                this.updateTranscript(data.transcript || '');
            }
            
            renderHypotheses(hypotheses) {
                const listHtml = hypotheses.map(hip => `
                    <div class="hipotese-item">
                        <div class="hipotese-header">
                            <span class="hipotese-nome">${hip.dx}</span>
                            <span class="confidence">${Math.round(hip.conf * 100)}%</span>
                        </div>
                        <div class="hipotese-razoes">
                            ${hip.porque.join(' ‚Ä¢ ')}
                        </div>
                    </div>
                `).join('');
                
                return `<div class="hipoteses-list">${listHtml}</div>`;
            }
            
            renderList(items, className) {
                const listItems = items.map(item => `<li>${item}</li>`).join('');
                return `<ul class="${className}">${listItems}</ul>`;
            }
            
            updateTranscript(newTranscript) {
                if (!newTranscript || newTranscript === this.currentTranscript) {
                    return;
                }
                
                this.currentTranscript = newTranscript;
                
                // Clear placeholder
                if (this.transcriptContent.querySelector('.transcript-placeholder')) {
                    this.transcriptContent.innerHTML = '';
                }
                
                // Check if this is new content
                const isNewContent = newTranscript.length > this.lastTranscriptLength;
                
                // Update transcript display
                this.transcriptContent.innerHTML = `<div class="transcript-text ${isNewContent ? 'transcript-new' : ''}">${newTranscript}</div>`;
                
                // Auto-scroll to bottom
                this.transcriptContent.scrollTop = this.transcriptContent.scrollHeight;
                
                // Update status
                if (newTranscript.trim()) {
                    this.transcriptStatus.textContent = `${newTranscript.split(' ').length} palavras`;
                }
                
                this.lastTranscriptLength = newTranscript.length;
                
                // Remove new highlight after animation
                setTimeout(() => {
                    const newElement = this.transcriptContent.querySelector('.transcript-new');
                    if (newElement) {
                        newElement.classList.remove('transcript-new');
                    }
                }, 500);
            }
            
            resetTranscript() {
                this.transcriptContent.innerHTML = `
                    <div class="transcript-placeholder">
                        Inicie a consulta para ver a transcri√ß√£o em tempo real...
                    </div>
                `;
                this.currentTranscript = '';
                this.lastTranscriptLength = 0;
            }
            
            handleFinalReport(report) {
                console.log('Relat√≥rio final recebido:', report);
                alert(`Consulta finalizada!\nID: ${report.encounter_id}\nRelat√≥rio dispon√≠vel no console.`);
                
                // Could save or display the final report here
                localStorage.setItem(`report_${report.encounter_id}`, JSON.stringify(report));
            }
        }
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MedicalRecordApp();
        });
    </script>
</body>
</html>